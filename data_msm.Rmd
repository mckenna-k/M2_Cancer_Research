---
title: "Package MSM"
author: "Shuyu, Marame, Kevin, Théo, Florence"
date: "01/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Import les données
data <- read.csv("data/TCGA-CDR_data.csv")
# Creation de donnee simule
covar_sim <- sample(c(0,1),1000,replace=TRUE)
covar <-  sample(c(0,1),11160,replace=TRUE)

#convert qq colonnes en numerique depuis les facteurs.
data$DSS.time <- as.numeric(as.character(data$DSS.time))
data$DSS <- as.numeric(as.character(data$DSS))
data$PFI.time <- as.numeric(as.character(data$PFI.time))
data$PFI <- as.numeric(as.character(data$PFI))

# Chqnge les valeurs de DSS.time et PFI.time au NA, (Car pas de sens un temps 0)
# ou si PFI.time est plus grand que DSS.time car aussi pas de sens.  
data$DSS.time[data$DSS.time==0] <- NA #enlever les suivis nuls
data$PFI.time[data$PFI.time==0] <- NA #enlever les suivis nuls
data$DSS.time[data$PFI.time > data$DSS.time] <- NA
data$PFI.time[data$PFI.time > data$DSS.time] <- NA


# Creation de colonnes pour la création de dataframe de matrice de transition
pfiNotDead.time <- data$PFI.time/365.25
pfiNotDead <- data$PFI
pfiNotDead[data$PFI.time==data$DSS.time] <- 0
dssDirect.time <- data$DSS.time/365.25
dssDirect <- data$DSS
dssDirect[!data$PFI.time==data$DSS.time] <- 0
dssRelapse.time <- (data$DSS.time-data$PFI.time)/365.25
dssRelapse.time[pfiNotDead==0] <- 0
dssRelapse <- data$DSS
dssRelapse[data$PFI.time==data$DSS.time] <- 0


# Recode les levels du stage du tumeur pour avoir moins de niveau.  
# Fait qu'il y a seulement stage 1/2, 3/4 et NA; ou 1/2, 3/4, autre et NA  
stage <- as.factor(data$ajcc_pathologic_tumor_stage)
levels(stage) <- c("NA","NA","NA","NA","I - II","I - II","other","I - II","I - II","I - II","I - II","I - II","I - II","I - II","III - IV","III - IV","III - IV","III - IV","III - IV","III - IV","III - IV","III - IV","other")
stageBis <- as.factor(data$clinical_stage)
levels(stageBis) <- c("NA","NA","NA","I - II","I - II","I - II","III - IV","III - IV","III - IV",rep("I - II",14),rep("III - IV",6),"I - II",rep("III - IV",4))
stage <- sapply(1:length(stage),function(i){
  if(stage[i]=="NA") return(stageBis[i])
  else return(stage[i])
})

# Creation d'un nouveau dataframe plus petit et facile a manipuler.  
df_new <- data.frame("Patient"=data$X,
                     "DSS"=data$DSS,"DSS.time"=data$DSS.time/365.25,
                     "PFI"=data$PFI,"PFI.time"=data$PFI.time/365.25,
                     "T01"=pfiNotDead,"T01.time"=pfiNotDead.time,
                     "T02"=dssDirect,"T02.time"=dssDirect.time,
                     "T12"=dssRelapse,"T12.time"=dssRelapse.time,
                     stage,"var_nulle"=as.character(covar),"gender"=data$gender,"age"=data$age_at_initial_pathologic_diagnosis,"type"=data$type)

# Enleve les NA
df_new <- df_new[-which(apply(df_new,1,function(x) any(is.na(x)))),]
dim(df_new)
# Enleve les stage qui ont le niveau NA ou other
df_new <- df_new[-which(is.element(df_new$stage,c("NA","other"))),]
df_new$stage <- factor(df_new$stage,c("I - II","III - IV"))
dim(df_new)
df_new$age <- as.numeric(as.character(df_new$age))
df_new <- df_new[-which(is.na(df_new$age)),] #nettoyage des NA de l'age
df_new$type <- as.character(df_new$type)
```

```{r}
library(msm)

#* Section plus compliquer a comprendre
#* Chaque personne peut atteindre max de 3 phase,  soit 1-1, 1-2-2, 1-3, ou 1-2-3 selon leur prognosis et leur censure. 
#* Donc il y a 3 matrice qui sont cree chaqu'un avec 4 colonne: indiv, time, state et type
#* Dans un boucle for du longeur du dataframe des patients (qu'on n'a pas retirer) pour chaque matrix, on regarde quel phase doit placer le patient
#* et on lui donne le bonne 'state'.  Si le personne n'a pas de troisieme phase, on met NA, qu'on enlevera apres.  
state1 <- matrix(nrow =length(df_new$Patient),ncol = 4,dimnames = list(1:length(df_new$Patient),c("indiv","time","state","type"))) 
state1 <- state2 <- state3<- as.data.frame(state1)
for(i in 1:length(df_new[,1])){
  state1[i,] <- c(df_new$Patient[i],0,1,df_new$type[i])
  state2[i,] <- 
    if((df_new$T01.time[i] < df_new$T02.time[i]) & df_new$T01[i]==1) c(df_new$Patient[i],df_new$T01.time[i],2,df_new$type[i])
  else if (df_new$T02[i] == 1) c(df_new$Patient[i],df_new$T02.time[i],3,df_new$type[i])
  else c(df_new$Patient[i],df_new$T02.time[i],1,df_new$type[i])
  state3[i,] <- 
    if((df_new$T01.time[i] < df_new$T02.time[i]) & df_new$T01[i]==1){
      if (df_new$T12.time[i] > 0 & df_new$T12[i]==1) c(df_new$Patient[i],df_new$T12.time[i]+df_new$T01.time[i],3,df_new$type[i])
      else c(df_new$Patient[i],df_new$T12.time[i]+df_new$T01.time[i],2,df_new$type[i])
    }
  else c(NA,NA,NA,NA)
}

# Combine les 3 matrices 
# Ajoute les colonnes depuis df_new pour utiliser les covariants
# Enleve les donnees qui on un 'state' == NA
df_msm <- rbind(state1,state2,state3)
df_msm$indiv <- as.numeric(as.character(df_msm$indiv))
df_msm$time <- as.numeric(as.character(df_msm$time))
df_msm$state <- as.numeric(as.character(df_msm$state))
df_msm$var_nulle <- as.character(covar[df_msm$indiv])
df_msm$stage <- df_new$stage[df_msm$indiv]
df_msm$age <- df_new$age[df_msm$indiv]
df_msm$gender <- df_new$gender[df_msm$indiv]
df_msm <- df_msm[-which(is.na(df_msm$state)),]

# Ordonner le dataframe par individu et le temps de chaque transition.  
df_msm <- df_msm[order(df_msm$indiv,df_msm$time),]







# Regarde le table de transition d'etats et cree un Q matrix de base.  
statetable.msm(state, indiv, df_msm)
Qmat <- matrix(c(1,1,1,0,1,1,0,0,0),ncol=3,byrow = TRUE)
par(mfrow = c(1,1))
test_msm <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'BRCA',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3,covariates = ~age)
#test_msm

#plot.prevalence.msm(test_msm)
```

###BRCA
##a vide

```{r}
test_msm_brca <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'BRCA',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3)
test_msm_brca
summary(test_msm_brca)
plot.prevalence.msm(test_msm_brca)
#plot(test_msm_brca )
```


##Var nulle

```{r}
test_msm_brca_nul <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'BRCA',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3,covariates = ~var_nulle)
#test_msm_brca_nul
summary(test_msm_brca_nul)$hazard
#plot.prevalence.msm(test_msm_brca_nul)
```

##Stage

```{r}
test_msm_brca_stage <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'BRCA',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3,covariates = ~stage)
#test_msm_brca_stage
summary(test_msm_brca_stage)$hazard
#plot.prevalence.msm(test_msm_brca_stage)

```

###PAAD
##a vide

```{r}
test_msm_paad <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'PAAD',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3)
test_msm_paad
plot.prevalence.msm(test_msm_paad)
```

##var nulle

```{r}
test_msm_paad_nul <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'PAAD',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3,covariates = ~var_nulle)
#test_msm_paad_nul
summary(test_msm_paad_nul)$hazard
#plot.prevalence.msm(test_msm_paad_nul)
```

##Stage

```{r}
test_msm_paad_stage <- msm(state~time, subject=indiv,data = df_msm[df_msm$type == 'PAAD',], gen.inits = TRUE,qmatrix= Qmat, deathexact = 3,covariates = ~stage)
summary(test_msm_paad_stage)$hazard
#plot.prevalence.msm(test_msm_paad_stage)
```

###Comparaison

##Stage

```{r}
summary(test_msm_brca_stage)$hazard
summary(test_msm_paad_stage)$hazard

```


##var nulle
```{r}
summary(test_msm_brca_nul)$hazard
summary(test_msm_paad_nul)$hazard

```

